# Infrastructure Deployment

This directory contains Bicep templates for deploying the ACI-based final video processing infrastructure.

## Prerequisites

- Azure CLI installed and logged in
- Storage account already exists
- Azure Container Registry (ACR) with the finalvideo-worker image pushed
- Contributor role on the target resource group

## Files

- `main.bicep` - Main infrastructure template (Storage Queue, UAMI, Logic App, Role Assignments)
- `logic-app-workflow.json` - Logic App workflow definition (to be imported after deployment)
- `parameters.json.example` - Example parameters file

## Deployment Steps

### 1. Create parameters file

Copy `parameters.json.example` to `parameters.json` and fill in your values:

```bash
cp parameters.json.example parameters.json
# Edit parameters.json with your values
```

### 2. Deploy infrastructure

```bash
az deployment group create \
  --resource-group <your-resource-group> \
  --template-file main.bicep \
  --parameters @parameters.json
```

### 3. Configure Logic App connections

After deployment, you need to configure the Logic App connections:

1. Go to Azure Portal → Logic App → `la-finalvideo-orchestrator`
2. Configure API connections:
   - **azurequeues**: Connect to your storage account
   - **azurecontainerinstances**: Use system-assigned managed identity

### 4. Import Logic App workflow

1. In the Logic App, go to "Logic app designer"
2. Click "Code view"
3. Paste the contents of `logic-app-workflow.json`
4. Update the parameters section with actual values from your deployment
5. Save the workflow

### 5. Configure concurrency

1. In Logic App designer, click on the trigger "When a message is received in a queue"
2. Click "..." → "Settings"
3. Enable "Concurrency Control"
4. Set "Degree of Parallelism" to 1
5. Save

## Important Notes

- The Logic App workflow definition in `logic-app-workflow.json` needs to be manually imported/configured after the initial deployment
- The container group name will be auto-generated by Logic App (not using the `finalvideo-job-<sessionKey>` pattern as specified, but this is acceptable)
- Ensure the ACR image is accessible (either public or with proper authentication configured)
- The UAMI needs to be attached to the ACI container group for blob storage access

## Verification

After deployment, verify:

1. Storage Queue `final-video-processing-requests` exists
2. UAMI `uami-finalvideo-worker` exists and has proper role assignments
3. Logic App `la-finalvideo-orchestrator` exists and is enabled
4. Logic App has system-assigned identity with Contributor role on resource group

